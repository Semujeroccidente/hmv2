// Esquema de base de datos para HonduMarket - Marketplace estilo eBay/Amazon

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Modelo de Usuario
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  password  String
  role      Role     @default(USER)
  status    UserStatus @default(ACTIVE)
  avatar    String?
  phone     String?
  bio       String?
  
  // Dirección
  address   Address?
  
  // Estadísticas
  rating    Float    @default(0)
  salesCount Int     @default(0)
  
  // Relaciones
  products  Product[]
  orders    Order[]
  reviews   Review[]
  bids      Bid[]
  sentMessages Message[] @relation("SentMessages")
  receivedMessages Message[] @relation("ReceivedMessages")
  favorites Favorite[]
  carts     Cart[]
  
  // Relaciones sociales
  followers Follow[] @relation("Following")
  following Follow[] @relation("Followers")
  
  reportsReported Report[] @relation("ReportedUser")
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Sistema de seguidores
model Follow {
  id          String   @id @default(cuid())
  followerId  String
  follower    User     @relation("Following", fields: [followerId], references: [id], onDelete: Cascade)
  followingId String
  following   User     @relation("Followers", fields: [followingId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  
  @@unique([followerId, followingId])
}

// Dirección de usuario
model Address {
  id        String  @id @default(cuid())
  street    String
  city      String
  state     String
  zipCode   String
  country   String  @default("HN")
  userId    String  @unique
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// Categorías de productos
model Category {
  id                String      @id @default(cuid())
  name              String      @unique
  slug              String      @unique
  description       String?
  icon              String?
  
  // Jerarquía
  level             Int         @default(1)
  visualOrder       Int         @default(0)
  active            Boolean     @default(true)
  
  // Atributos específicos
  attributeTemplate String?     // JSON: define qué atributos pide esta categoría (ej: "talla", "color")
  
  // Relaciones
  products          Product[]   @relation("PrimaryCategory")
  secondaryProducts Product[]   @relation("SecondaryCategories")
  
  parent            Category?   @relation("CategoryHierarchy", fields: [parentId], references: [id])
  parentId          String?
  children          Category[]  @relation("CategoryHierarchy")
  
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
}

// Productos
model Product {
  id          String      @id @default(cuid())
  title       String
  description String
  price       Float
  originalPrice Float?
  
  // Estado y condición
  condition   Condition   @default(NEW)
  status      ProductStatus @default(ACTIVE)
  stock       Int         @default(1)
  
  // Multimedia
  images      String?     // JSON string de array de imágenes
  thumbnail   String?
  
  // Métricas
  views       Int         @default(0)
  favoritesCount Int      @default(0)
  
  // SEO y búsqueda
  slug        String      @unique
  tags        String?     // JSON string de array de tags
  
  // Atributos dinámicos
  attributes  String?     // JSON: valores de los atributos (ej: {"color": "rojo"})
  
  // Relaciones
  sellerId    String
  seller      User        @relation(fields: [sellerId], references: [id])
  
  categoryId  String
  category    Category    @relation("PrimaryCategory", fields: [categoryId], references: [id])
  
  // Categorías adicionales (hasta 3 en total con la principal)
  otherCategories Category[] @relation("SecondaryCategories")
  
  reviews     Review[]
  orderItems  OrderItem[]
  favorites   Favorite[]
  auction     Auction?
  cartItems   CartItem[]
  reports     Report[]
  
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
}

// Carrito de compras
model Cart {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  status    CartStatus @default(ACTIVE)
  total     Float    @default(0)
  
  items     CartItem[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Items del carrito
model CartItem {
  id        String   @id @default(cuid())
  cartId    String
  cart      Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)
  productId  String
  product   Product  @relation(fields: [productId], references: [id])
  quantity   Int      @default(1)
  price      Float    // Precio al momento de añadir al carrito
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Subastas
model Auction {
  id            String    @id @default(cuid())
  productId     String    @unique
  product       Product   @relation(fields: [productId], references: [id])
  
  startingPrice Float
  currentPrice  Float
  reservePrice  Float?
  bidIncrement  Float     @default(50)
  
  endDate       DateTime
  status        AuctionStatus @default(ACTIVE)
  
  // Tracking de pujas
  bidCount      Int       @default(0)
  lastBidder    String?
  lastBidTime   DateTime?
  winnerId      String?
  
  // Proxy Bidding
  hasProxyBids  Boolean   @default(false)
  
  // Time Extension (Anti-Snipe)
  originalEndDate DateTime?
  extensionMinutes Int     @default(5)
  timesExtended   Int      @default(0)
  maxExtensions   Int      @default(10)
  
  // Scheduled Auctions
  startDate     DateTime?
  autoStart     Boolean   @default(true)
  
  // Buy It Now
  buyNowPrice   Float?
  buyNowEnabled Boolean   @default(false)
  buyNowUserId  String?
  
  bids          Bid[]
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([status, endDate])
  @@index([status, startDate])
}

// Pujas de subasta
model Bid {
  id        String   @id @default(cuid())
  amount    Float
  maxAmount Float?   // Puja máxima para proxy bidding
  isProxy   Boolean  @default(false) // Indica si es puja automática
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  auctionId String
  auction   Auction  @relation(fields: [auctionId], references: [id])
  
  createdAt DateTime @default(now())
  
  @@index([auctionId, amount])
  @@index([auctionId, isProxy])
}

// Pedidos
model Order {
  id            String      @id @default(cuid())
  orderNumber   String      @unique
  
  // Estado del pedido
  status        OrderStatus @default(PENDING)
  paymentStatus PaymentStatus @default(PENDING)
  
  // Totales
  subtotal      Float
  shippingCost  Float       @default(0)
  tax           Float       @default(0)
  total         Float
  
  // Información de envío
  shippingAddress Json // Dirección serializada
  
  // Relaciones
  userId        String
  user          User        @relation(fields: [userId], references: [id])
  items         OrderItem[]
  
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
}

// Items del pedido
model OrderItem {
  id          String  @id @default(cuid())
  quantity    Int
  price       Float
  
  orderId     String
  order       Order   @relation(fields: [orderId], references: [id])
  productId   String
  product     Product @relation(fields: [productId], references: [id])
  
  createdAt   DateTime @default(now())
}

// Reseñas
model Review {
  id        String   @id @default(cuid())
  rating    Int      // 1-5 estrellas
  comment   String?
  
  productId String
  product   Product  @relation(fields: [productId], references: [id])
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

}

// Reportes de moderación
model Report {
  id          String   @id @default(cuid())
  type        String   // review, user, product, auction, system
  description String
  reportedBy  String   // Puede ser ID de usuario o nombre si es anonimo (aunque sistema actual usa auth)
  
  // Objetos reportados (opcionales)
  productId   String?
  product     Product? @relation(fields: [productId], references: [id])
  userId      String?  // Usuario reportado
  user        User?    @relation("ReportedUser", fields: [userId], references: [id])
  
  status      String   @default("pending") // pending, reviewing, resolved, dismissed
  
  // Datos de moderación
  reviewedBy  String?
  reviewedAt  DateTime?
  resolvedAt  DateTime?
  notes       String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}


// Mensajes entre usuarios
model Message {
  id        String   @id @default(cuid())
  content   String
  
  senderId  String
  sender    User     @relation("SentMessages", fields: [senderId], references: [id])
  receiverId String
  receiver  User     @relation("ReceivedMessages", fields: [receiverId], references: [id])
  
  productId String?
  
  read      Boolean  @default(false)
  
  createdAt DateTime @default(now())
}

// Productos favoritos
model Favorite {
  id        String   @id @default(cuid())
  
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  productId String
  product   Product  @relation(fields: [productId], references: [id])
  
  createdAt DateTime @default(now())
  
  @@unique([userId, productId])
}

// Enums
enum Role {
  USER
  SELLER
  ADMIN
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum CartStatus {
  ACTIVE
  ABANDONED
  CONVERTED
}

enum Condition {
  NEW
  USED
  REFURBISHED
}

enum ProductStatus {
  ACTIVE
  SOLD
  INACTIVE
  DRAFT
}

enum AuctionStatus {
  SCHEDULED
  ACTIVE
  ENDED
  CANCELLED
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  PAID
  REFUNDED
  FAILED
}